<!doctype html>
<html
    ng-app="apiUtils"
    ng-controller="globalController"
    ng-init='user = {{user}}; api_key="{{api_key}}"'
>

 <title>KDM API - Admin Panel</title>

 <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-animate.js"></script>

    <script src="/static/js/_global.js"></script>
    <script src="/static/js/adminPanel.js"></script>

    <link rel="stylesheet" href="/static/css/fonts.css" />
    <link rel="stylesheet" href="/static/css/apiUtils.css" />
    <link rel="stylesheet" href="/static/css/adminPanel.css" />
    <link rel="stylesheet" href="/static/css/color.css" />

    <link rel="stylesheet" href="/kingdomDeath.css" />

    <link href="https://fonts.googleapis.com/css?family=Ruda&display=swap" rel="stylesheet">
 </head>

 <body ng-controller="adminPanelController">

    <img
        id="mainSpinner"
        class="ng_fade"
        src="/static/media/images/loading_io.gif"
        ng-if="ngVisible['mainSpinner']"
    />

    <div class="container">

        <div class="flex_item_basic">

            <!-- admin panel corner detail -->
            <div
                class="clickable corner"
                ng-click="ngShowHide('adminPanelReleaseDetails')"
            >
            </div>

            <div
                id="adminPanelReleaseDetails"
                class="hidden modal_outer"
                ng-if="ngVisible['adminPanelReleaseDetails']"
            >

                <div class="modal_inner admin_panel_release_details"/>

                    <h2 class="kd title">KDM API</h2> 
                    <div
                        class="kd worksheet_block"
                    >
                        <div class="kd_worksheet_row">
                            <b>Panel Revision:</b> {a settings.meta.api.panel.panel_revision a}
                        </div>
                        <div class="kd_worksheet_row">
                            <b>Last Refreshed:</b> {a refreshed a} ({a seconds_since_last_refresh a} seconds ago)
                        </div>
                        <div class="kd_worksheet_row">
                            <b>Last Push:</b> {a github.pushed_at a}
                        </div>
                        <div class="kd_worksheet_row">
                            <b>Open API Issues:</b> {a github.open_issues a}
                        </div>
                    </div> <!-- worksheet block -->

                    <h2 class="kd title">Resources</h2> 
                    <div
                        class="kd worksheet_block"
                    >
                        <div
                            ng-repeat="(href, desc) in {
                                '/stat': 'API Settings',
                                '/': 'API Documentation',
                                '/blog': 'Development Blog',
                                '/https://github.com/theLaborInVain/kdm-manager-api': 'GitHub',
                            }"
                            class="kd worksheet_row"
                        >
                            <div
                                class="kd checkbox checked"
                            >
                            </div>
                            <div
                                class="kd checkbox_desc"
                            >
                                <a ng-href="href">{a desc a}</a>
                            </div>
                        </div>
                    </div>

                    <button
                        ng-click="ngShowHide('adminPanelReleaseDetails')"
                        class="clickable capsule kd yellow"
                    >
                        Close
                    </button>

                </div><!-- modal inner -->

            </div><!-- modal outer -->

            <!-- main admin panel info -->

            <h1>KDM API</h1>
            <b>API Hostname:</b> {a settings.meta.server.hostname a}<br/>
            <b>API Version:</b> {a settings.meta.api.version a}<br/>

            <!-- set admin user JWT/password -->

            <form
                class="text_input_container zebra"
                ng-if="user.jwt === undefined"
            >

                <input
                    type="password"
                    class="text_input_input"
                    placeholder="{a user.login a} password"
                    ng-model="user.plaintext_password"
                />
                <button
                    type="submit"
                    class="text_input_button"
                    ng-click="
                        setUserJWT();
                        $event.stopPropagation();
                    "
                >
                    Set JWT
                </button>

            </form>

            <div
                ng-if="user.jwt === undefined"
                class="hidden error_text_block"
                id="adminPasswordInputError"
            >
                <b>Authorization Error!</b>
                <span id="adminPasswordInputErrorMsg"></span>
            </div>


        </div>

        {% include 'admin_panel/releases.html' %}

        {% include 'admin_panel/alerts.html' %}

        {% include 'admin_panel/users.html' %}


    <!-- RECENT SETTLEMENTS WILL GO HERE -->


        <div class="flex_item_basic flex_item_double_wide api">
            <h2>API Response Times (last seven days)</h2>
            <table class="api_response_times">
            <tr>
                <th>Method</th>
                <th>Route</th>
                <th>#</th>
                <th>24Hrs</th>
                <th>Avg.</th>
                <th>Min</th>
                <th>Max</th>
            </tr>
            <tr ng-repeat="r in world.world.api_response_times.value">
                <td>{a r._id.method a}</td>
                <td class="url"><code>/{a r._id.url a}</code></td>
                <td>{a r.count a}</td>
                <td>{a r.last_24_avg | limitTo:5 a}</td>
                <td ng-class="{'warning': r.avg_time >= 2, 'error': r.avg_time >=4}">{a r.avg_time | limitTo:5 a}</td>
                <td ng-class="{'warning': r.min_time >= 2, 'error': r.min_time >=4}">{a r.min_time | limitTo:5 a}</td>
                <td ng-class="{'warning': r.max_time >= 2, 'error': r.max_time >=4}">{a r.max_time | limitTo:5 a}</td>
            </tr>
            </table>
        </div>


        <div class="flex_item_basic world" ng-if="world.world.current_hunt.value != null">
            <h2>{a world.world.current_hunt.name a}</h2>
            {a world.world.current_hunt.comment a}<hr/>

            <b>Settlement:</b> <i>{a world.world.current_hunt.value.settlement.name a}</i> (LY: {a world.world.current_hunt.value.settlement.lantern_year a})<br/>
            <b>Quarry:</b> {a world.world.current_hunt.value.settlement.current_quarry a}<br/>
            <b>Departing Survivors:</b>
            <table>
                <tr
                    ng-repeat="s in world.world.current_hunt.value.survivors"
                >
                    <td>{a s.name a}</td><td class="int_key">{a s.sex a}</td>
                </tr>
            </table>
        </div>

        <!-- main 'latest' box -->
        <div class="flex_item_basic world">
            <h2>{a world.world.latest_settlement.name a}</h2>
            {a world.world.latest_settlement.comment a}

            <div ng-click="showHide('latest_settlement_detail')" class="clickable tile">
                <b>{a world.world.latest_settlement.value.name a}</b><br/>
                <i>{a world.world.latest_settlement.value.campaign a} - LY {a world.world.latest_settlement.value.lantern_year a}</i>
            </div>

            <table id='latest_settlement_detail' class="hidden">
                <tr ng-repeat="(k,v) in world.world.latest_settlement.value" ng-class-even="'zebra'">
                    <td class="int_key">{a k a}</td> <td>{a v a}</td>
                </tr>
            </table>

            <hr/>

            <h2>{a world.world.latest_survivor.name a}</h2>
            {a world.world.latest_survivor.comment a}

            <div ng-click="showHide('latest_survivor_detail')" class="clickable tile">
                <b>{a world.world.latest_survivor.value.name a}</b> [{a world.world.latest_survivor.value.sex a}]<br/>
                <i>{a world.world.latest_survivor.value.settlement_name a}</i>
            </div>

            <table id='latest_survivor_detail' class="hidden">
                <tr ng-repeat="(k,v) in world.world.latest_survivor.value" ng-class-even="'zebra'">
                    <td class="int_key">{a k a}</td> <td>{a v a}</td>
                </tr>
            </table>

            <hr/>

            <h2>{a world.world.latest_fatality.name a}</h2>
            {a world.world.latest_fatality.comment a}

            <div ng-click="showHide('latest_fatality_detail')" class="clickable tile">
                <b>{a world.world.latest_fatality.value.name a}</b> [{a world.world.latest_survivor.value.sex a}]<br/>
                <i>{a world.world.latest_fatality.value.settlement_name a}</i>
            </div>

            <table id='latest_fatality_detail' class="hidden">
                <tr ng-repeat="(k,v) in world.world.latest_fatality.value" ng-class-even="'zebra'">
                    <td class="int_key">{a k a}</td> <td>{a v a}</td>
                </tr>
            </table>

            <hr/>

            <h2>{a world.world.latest_kill.name a}</h2>
            {a world.world.latest_kill.comment a}

            <div ng-click="showHide('latest_kill_detail')" class="clickable tile">
                <b>{a world.world.latest_kill.value.raw_name a}</b> ({a world.world.latest_kill.type a})<br/>
                Killed by the survivors of <i>{a world.world.latest_kill.value.settlement_name a}</i> in LY {a world.world.latest_kill.value.kill_ly a}
            </div>

            <table id='latest_kill_detail' class="hidden">
                <tr ng-repeat="(k,v) in world.world.latest_kill.value" ng-class-even="'zebra'">
                    <td>{a k a}</td> <td>{a v a}</td>
                </tr>
            </table>

        </div>

        <!-- killboard -->
        <div class="flex_item_basic world">
            <h2>{a world.world.killboard.name a}</h2>
            {a world.world.killboard.comment a}<br/>
            <div ng-repeat="(type,board) in world.world.killboard.value">
                <h3 class="capitalize">{a type a}</h3>
                <table>
                    <tr ng-repeat="row in board" ng-class-even="'zebra'">
                        <td>{a row.name a}</td> <td class="int_key">{a row.count a}</td>
                    </tr>
                </table>
            </div>
        </div>


        <div class="flex_item_basic world">
            <h2>{a world.world.settlement_popularity_contest_campaigns.name a}</h2>
            {a world.world.settlement_popularity_contest_campaigns.comment a}
            <table>
                <tr ng-repeat="(name,count) in world.world.settlement_popularity_contest_campaigns.value" ng-class-even="'zebra'">
                    <td>{a name a}</td> <td class="int_key">{a count a}</td>
                </tr>
            </table>
            <h2>{a world.world.settlement_popularity_contest_expansions.name a}</h2>
            {a world.world.settlement_popularity_contest_expansions.comment a}
            <table>
                <tr ng-repeat="e in world.world.settlement_popularity_contest_expansions.value" ng-class-even="'zebra'">
                    <td>{a e.name a}</td> <td class="int_key">{a e.count a}</td>
                </tr>
            </table>


            <h2>{a world.world.top_innovations.name a}</h2>
            {a world.world.top_innovations.comment a}
            <table>
                <tr ng-repeat="row in world.world.top_innovations.value" ng-class-even="'zebra'">
                    <td>{a row.name a}</td> <td class="int_key">{a row.count a}</td>
                </tr>
            </table>

            <h2>{a world.world.principle_selection_rates.name a}</h2>
            {a world.world.principle_selection_rates.comment a}
            <div ng-repeat="(principle, selections) in world.world.principle_selection_rates.value">
                <h3 class="capitalize">{a principle a}</h3>
                <table>
                    <tr><td></td><td>#</td><td>%</td></tr>
                    <tr ng-repeat="option in selections.options" ng-class-odd="'zebra'">
                        <td>{a option a}</td>
                        <td class="int_key">{a selections[option].total a}</td>
                        <td class="int_key">{a selections[option].percentage a}</td>
                    </tr>
                </table>
            </div>

        </div>

        <div class="flex_item_basic world">
            <h2>{a world.world.top_settlement_names.name a}</h2>
            {a world.world.top_settlement_names.comment a}<br/>
            <table>
                <tr ng-repeat="row in world.world.top_settlement_names.value" ng-class-even="'zebra'">
                    <td>{a row.name a}</td> <td class="int_key">{a row.count a}</td>
                </tr>
            </table>
            <h2>{a world.world.top_survivor_names.name a}</h2>
            {a world.world.top_survivor_names.comment a}<br/>
            <table>
                <tr ng-repeat="row in world.world.top_survivor_names.value" ng-class-even="'zebra'">
                    <td>{a row.name a}</td> <td class="int_key">{a row.count a}</td>
                </tr>
            </table>
            <h2>{a world.world.top_causes_of_death.name a}</h2>
            {a world.world.top_causes_of_death.comment a}<br/>
            <table>
                <tr ng-repeat="row in world.world.top_causes_of_death.value" ng-class-even="'zebra'">
                    <td>{a row.cause_of_death a}</td> <td class="int_key">{a row.count a}</td>
                </tr>
            </table>
        </div>

        <div class="flex_item_basic world">
            <h2>World Stats</h2>

            <div
                class="world_item clickable tile"
                ng-repeat="w in world.world"
                ng-if="w.value_type == 'int' || w.value_type == 'float'" 
            >
                <div
                    title="{a w.comment a}"
                    ng-click="showHide(w.handle + '_tooltip')"
                >
                    <div class="world_key">{a w.name a} ({a w.value_type a}):</div>
                    <div class="world_value">{a w.value a}</div>
                    <span id="{a w.handle a}_tooltip" class="world_tooltip hidden">
                        <i>comment:</i> {a w.comment a}<br/>
                        <i>handle:</i> <code>{a w.handle a}</code><br/>
                        <i>mdb OID:</i> {a w._id.$oid a}<br/>
                        <i>refreshed:</i> {a w.created_on.$date a}<br/>
                        <i>age (seconds):</i> {a w.age_in_seconds a}
                    </span>
                </div>
            </div>
        </div>

    </div> <!-- container -->

 </body>

</html>
